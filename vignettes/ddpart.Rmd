---
title: "ddpart"
author: "Andreas Schmitz"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{ddpart}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Package installation

Install the package
```{r install}
devtools::install_github(
  repo = "https://github.com/AndSchmitz/ddpart"
)
library(ddpart)
```

Dependencies for this vignette
```{r deps}
library(tidyr)
library(knitr)
library(scales)
library(ggplot2)
```

# Validation

Emerson et al. (2020) figures 1 and 2 show the dry deposition velocity as a a
function of particle diameter for different settings (i.e. for different land
use types, friction velocity, etc.). In the following, these figures are
reproduced as a validation of the functions in the ddpart package.

## Contribution from DD sub-processes

Emerson et al. (2020) figure 2 shows the contribution of the four dry deposition
sub-processes (Brownian motion, interception, impaction and gravitational
settling) to the total dry deposition velocity. This figure is reconstructed
with functions from the ddpart package. 

### Definition of parameters

```{r Emerson fig 2B parameters}

# Vector of particle diameters
d_p_vec <- 10^seq(-2, 2, length.out = 5)
tmp <- expand.grid(1:9, d_p_vec)
d_p_vec <- tmp[, 1] * tmp[, 2]
d_p_vec <- d_p_vec[d_p_vec <= 100]
d_p_vec <- d_p_vec * 1e-6

InputPars <- data.frame(
  R_a_sm = 0,
  Parametrization = "Emerson20",
  LUC = 1,
  Season = 1,
  ParticleDensity_kgm3 = 1200,
  FrictionVelocity_ms = 0.4
) %>%
  mutate(
    RoughnessLength_m = GetLandUseParameters(
      LUCs = LUC,
      Seasons = Season,
      TargetPar = "z_0_m",
      Parametrization = Parametrization
    ),
    #These parameters are guessed
    #Standard temperatur and pressure
    T_air_K = 293.15,
    AirPressure_Pa = 101325,
    SurfaceIsWet_bool = F,
    #FIXME document
    ZeroPlaneDisplacementHeight_m = 7 * RoughnessLength_m
  )

#Duplicate input for Zhang01 parametrization
tmp <- InputPars %>%
  mutate(
    Parametrization = "Zhang01"
  )
InputPars <- bind_rows(InputPars, tmp)

Input <- expand_grid(
  InputPars,
  ParticleDiameter_m = d_p_vec
)
```

### Calculations

```{r Emerson fig 2B Calculations}
Output <- Input %>%
  mutate(
    #Meteo basics
    DynamicViscosityAir_kgms = CalculateDynamicViscosityOfAir(
      T_air_K = T_air_K
    ),
    AirDensity_kgm3 = CalculateAirDensity(
      AirPressure_Pa,
      T_air_K
    ),
    KinematicViscosityOfAir_m2s = CalculateKinematicViscosityOfAir(
      DynamicViscosityAir_kgms = DynamicViscosityAir_kgms,
      AirDensity_kgm3 = AirDensity_kgm3
    ),
    MeanFreePathOfAirMolecule_m = CalculateMeanFreePath(
      T_air_K = T_air_K,
      AirPressure_Pa = AirPressure_Pa,
      DynamicViscosityAir_kgms = DynamicViscosityAir_kgms
    ),
    #Deposition processes------
    SettlingVelocity_ms = CalculateSettlingVelocity (
      ParticleDensity_kgm3 = ParticleDensity_kgm3,
      ParticleDiameter_m = ParticleDiameter_m,
      MeanFreePathOfAirMolecule_m = MeanFreePathOfAirMolecule_m,
      DynamicViscosityAir_kgms = DynamicViscosityAir_kgms
    ),
    #_Schmidt number------
    SchmidtNumber = CalculateSchmidtNumber(
      DynamicViscosityAir_kgms = DynamicViscosityAir_kgms,
      KinematicViscosityOfAir_m2s = KinematicViscosityOfAir_m2s,
      T_air_K = T_air_K,
      ParticleDiameter_m = ParticleDiameter_m
    ),
    #_E_b-----
    #Loss efficiency by Brownian diffusion
    BrownianDiffusionParameterGamma = GetLandUseParameters(
      LUCs = LUC,
      Seasons = Season,
      TargetPar = "gamma",
      Parametrization = Parametrization
    ),
    E_b = CalculateLossEfficiencyBrownianDiffusion(
      SchmidtNumber = SchmidtNumber,
      BrownianDiffusionParameterGamma = BrownianDiffusionParameterGamma,
      Parametrization = Parametrization
    ),
    #_Stokes number-----
    SurfaceIsVegetated = GetLandUseParameters(
      LUCs = LUC,
      Seasons = Season,
      TargetPar = "SurfaceIsVegetated",
      Parametrization = Parametrization
    ),
    CharacteristicRadius_m = GetLandUseParameters(
      LUCs = LUC,
      Seasons = Season,
      TargetPar = "A_mm",
      Parametrization = Parametrization
    ) * 1e-3,
    StokesNumber = CalculateStokesNumber(
      FrictionVelocity_ms = FrictionVelocity_ms,
      SettlingVelocity_ms = SettlingVelocity_ms,
      CharacteristicRadius_m = CharacteristicRadius_m,
      KinematicViscosityOfAir_m2s = KinematicViscosityOfAir_m2s,
      SurfaceIsVegetated = SurfaceIsVegetated
    ),
    #_E_Im----
    #Loss efficiency by impaction
    ImpactionParameterAlpha = GetLandUseParameters(
      LUCs = LUC,
      Seasons = Season,
      TargetPar = "alpha",
      Parametrization = Parametrization
    ),
    E_Im = CalculateLossEfficiencyImpaction(
      StokesNumber = StokesNumber,
      ImpactionParameterAlpha = ImpactionParameterAlpha,
      Parametrization = Parametrization
    ),
    #_E_In----
    #Loss efficiency by interception
    E_In = CalculateLossEfficiencyInterception(
      ParticleDiameter_m = ParticleDiameter_m,
      CharacteristicRadius_m = CharacteristicRadius_m,
      Parametrization = Parametrization
    ),
    #_R_s-----
    #Surface resistance
    R_s_sm = CalculateSurfaceResistance(
      SurfaceIsWet = SurfaceIsWet_bool,
      FrictionVelocity_ms = FrictionVelocity_ms,
      StokesNumber = StokesNumber,
      E_b = E_b,
      E_Im = E_Im,
      E_In = E_In,
      Parametrization = Parametrization
    ),
    #_V_d---------
    V_d_s = 1 / (R_a_sm + R_s_sm),
    V_g = SettlingVelocity_ms,
    V_d_ms = V_d_s + V_g,
    Type = "Results from ddpart"
  )

#Plot separate dry deposition processes contributions
ProcessContributions <- Output %>%
  mutate(
    BounceCorrectionTerm = ifelse(
      test = SurfaceIsWet_bool,
      yes = 1,
      no = exp(-sqrt(StokesNumber))
    ),
    #Calculation of resistances and corresponding vd's for each process
    epsilon_0 = GetParameters(TargetParameter = "epsilon_0", Parametrization = Parametrization),
    R_s_E_b_only = 1 / (epsilon_0 * FrictionVelocity_ms * BounceCorrectionTerm * E_b),
    V_d_E_b_only = 1 / (R_a_sm + R_s_E_b_only),
    R_s_E_Im_only = 1 / (epsilon_0 * FrictionVelocity_ms * BounceCorrectionTerm * E_Im),
    V_d_E_Im_only = 1 / (R_a_sm + R_s_E_Im_only),
    R_s_E_In_only = 1 / (epsilon_0 * FrictionVelocity_ms * BounceCorrectionTerm * E_In),
    V_d_E_In_only = 1 / (R_a_sm + R_s_E_In_only)
  ) %>%
  select(Parametrization,ParticleDiameter_m,V_d_E_b_only,V_d_E_Im_only,V_d_E_In_only,V_d_ms, SettlingVelocity_ms) %>%
  pivot_longer(
    cols = -c("Parametrization", "ParticleDiameter_m"),
    names_to = "Component",
    values_to = "v"
  ) %>%
  mutate(
    ComponentName = case_when(
      Component == "V_d_E_b_only" ~ "Brownian",
      Component == "V_d_E_Im_only" ~ "Impaction",
      Component == "V_d_E_In_only" ~ "Interception",
      Component == "SettlingVelocity_ms" ~ "Settling",
      Component == "V_d_ms" ~ "Total"
    )
  )
```

### Plots

```{r Emerson fig 2B Plots}
#Load data extracted from Emerson et al. (2020)
#FIXME ADD dataset description
data(dd_subprocess_validation)
ValidationData <- dd_subprocess_validation %>%
  mutate(
    Label = factor(
      x = Parametrization,
      levels = c("Zhang01", "Emerson20")
    ),
    Type = "Extracted from Emerson et al. (2020)"
  )
ProcessContributions <- ProcessContributions %>%
  mutate(
    Label = factor(
      x = Parametrization,
      levels = c("Zhang01", "Emerson20")
    ),
    Type = "Calculated with ddpart"    
  )

Colors <- c("black","blue","orange","darkred","purple")
names(Colors) <- c("Total","Brownian","Settling","Interception","Impaction")
Shapes <- 3
names(Shapes) = "Calculated with ddpart"

ggplot() +
  geom_line(
    data = ValidationData,
    mapping = aes(
      x = ParticleDiameter_um,
      y = DepositionVelocity_cms,
      color = Process,
      linetype = Type
    )
  ) +
  geom_point(
    data = ProcessContributions,
    mapping = aes(
      x = ParticleDiameter_m*1e6,
      y = v*100,
      color = ComponentName,
      shape = Type
    ),
    size = 2
  ) +
  scale_shape_manual(values = Shapes) +
  scale_color_manual(values = Colors) +
  scale_x_log10(
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)),
    expand = expansion(mult = c(0, 0))
  ) +
  scale_y_log10(
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)),
    limits = c(1e-3,1e2),
    expand = expansion(mult = c(0, 0))
  ) +
  annotation_logticks() +
  xlab("Particle diameter (um)") +
  ylab("Deposition velocity (cm/s)") +
  theme(
    legend.position = "bottom",
    legend.title = element_blank()
  ) +
  facet_wrap( ~Label)
```

# References

Seinfeld JH, Pandis SN. Atmospheric Chemistry and Physics: From Air Pollution to Climate Change. Second edition. Wiley; 2006.

Zhang L, Gong S, Padro J, Barrie L. A size-segregated particle dry deposition scheme for an atmospheric aerosol module. Atmospheric Environment 2001;35:549–560.

Emerson EW, Hodshire AL, DeBolt HM, Bilsback KR, Pierce JR, McMeeking GR, Farmer DK. Revisiting particle dry deposition and its role in radiative effect estimates. Proceedings of the National Academy of Sciences 2020;117:26076–26082.
